#+TITLE: Lymphoblast Rearrangement Analysis 
#+DATE:  <2016-01-18>
#+EMAIL: rscharpf@jhu.edu
#+AUTHOR:  Rob Scharpf

* Overview

Extract processed data for the lymphoblast cell lines from the Ovarian
cell line project to define germline filters that can be used in other
projects.

* Packages and Rscript options
** variables passed from bash shell
#+name: shell_args
#+BEGIN_SRC R 
  message("shell_args")
  library(getopt)
  spec <- matrix(c("id", "f", 1, "character"),
                 byrow=TRUE, ncol=4)
  opt <- getopt(spec) 
  ## If 'id' was defined by user, then do not extract the id from opts.
  ## This is useful for debugging
  if(!exists("id")){
    id <- gsub(".rds", "", opt$id)
    if (id == ".rds") {
      stop("id not found")
    }
  }
  cat("id: ", id, "\n")
#+END_SRC
 
** R packages
#+name: packages
#+BEGIN_SRC R 
  library(svclasses)
  library(svpreprocess)
  library(svovarian)
  library(svfilters)
  library(svcnvs)
#+END_SRC

** Preprocess

#+name: data_paths
#+BEGIN_SRC R
  dp <- projectOvarian()
#+END_SRC

#+name: bamviews
#+BEGIN_SRC R
  bviews <- readRDS(file.path(dp[["data"]], "bviews_hg19.rds"))
  bviews <- bviews[, lymphIds(dp)]
#+END_SRC

#+name: preprocess
#+BEGIN_SRC R
  pviews <- sv_preprocess(bviews[, id], dp)
#+END_SRC

#+name: segment
#+BEGIN_SRC R
  grl <- segmentExperiment(pviews[, id], dp)
#+END_SRC


** Germline filter tracks

*** Read depth tracks

#+name: germline_filters
#+BEGIN_SRC R 
  ##--------------------------------------------------
  ##
  message("germline_filters") 
  ##
  ##--------------------------------------------------
  ids <- lymphIds(dp)
  pviews <- sv_preprocess(bviews[, ids], dp)
  grl <- segmentExperiment(pviews, dp)
  g <- unlist(grl)
  amps <- granges(g[g$seg.mean >= 1])
  dels <- granges(g[g$seg.mean <= -1])
  outs <- granges(germlineOutliers(pviews, NMAD=5))
  outs$seg.mean <- granges_copynumber(outs, pviews)
  dels$seg.mean <- granges_copynumber(dels, pviews)
  amps$seg.mean <- granges_copynumber(amps, pviews)
  outs$type <- "outlier"
  dels$type <- "deletion"
  amps$type <- "amplicon"
  tracks <- GRangesList(list(amplicon=amps, deletion=dels, outlier=outs))
#+END_SRC

#+name: save_germline_tracks
#+BEGIN_SRC R 
  ##--------------------------------------------------
  ##
  message("save_germline_tracks") 
  ##
  ##--------------------------------------------------
  path <- "~/Software/svpackages/svfilters/data"
  lymphoblast_filters_hg19 <- tracks
  save(lymphoblast_filters_hg19, file=file.path(path, "lymphoblast_filters_hg19.rda"))
#+END_SRC

*** Rearrangement filters

#+name: combine_filters
#+BEGIN_SRC R 
  ##--------------------------------------------------
  ##
  message("combine_filters") 
  ##
  ##--------------------------------------------------
  data(lowMappabilityBins_hg19, package="svfilters")
  data(binAssemblyGaps_hg19, package="svfilters")
  gfilters <- as(tracks, "list")
  gfilters$map <- lowMappabilityBins_hg19
  gfilters$gc <- binAssemblyGaps_hg19
  germline_filters <- reduce(unlist(GRangesList(lapply(gfilters, granges))))
#+END_SRC

#+name: rearrangements
#+BEGIN_SRC R 
  ##--------------------------------------------------
  ##
  message("rearrangements") 
  ##
  ##--------------------------------------------------
  rp <- RearrangementParams()
  rlist_exp <- rearExperiment(dp, aviews[, id], rp=rp)
#+END_SRC

* Workflows
** Hard-threshold deletions/amplicons
#+BEGIN_SRC R :tangle lymphoblast_cnvs.R :noweb yes
  <<shell_args>>
  <<packages>>
  <<data_paths>>
  <<bamviews>>
  <<preprocess>>
  <<segment>>
  <<rearrangements>>
#+END_SRC

#+BEGIN_SRC sh :tangle lymphoblast_cnvs.sh
  #!/bin/bash
  #$ -cwd
  #$ -j y
  #$ -l mem_free=5G
  #$ -l h_vmem=20G
  #$ -l h_rt=12:00:00
  #$ -pe local 1
  #$ -t 1-10
  WD=$PWD
  datapkg="../../../OvarianData" 
  manifest="${datapkg}/extdata/manifest" 
  echo $manifest
  cd $manifest
  input=$(ls -1v * | head -n $SGE_TASK_ID | tail -n 1)
  output_file="${datapkg}/data/rearrangements/${input}.rds"
  echo $output_file
  rlib="${HOME}/Library/R/3.2-bioc-devel/library"
  cd $WD
  if [ ! -f $output_file ]; then
      R_LIBS_USER=$rlib Rscript lymphoblast_cnvs.R --id $input
  fi
#+END_SRC


** Lymphoblast-derived filters
#+BEGIN_SRC R :tangle lymphoblast_filters.R :noweb yes
  <<packages>>
  <<data_paths>>
  <<bamviews>>
  <<germline_filters>>
  <<save_germline_tracks>>
#+END_SRC













